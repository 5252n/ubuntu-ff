name: ubunturdp
on: 
  workflow_dispatch:
    inputs:
      auth:
        description: 'Chrome Remote Desktop Authorization Code'
        required: false
        default: 'paste your code here'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: Create User
      run: |
        sudo useradd -m -s /bin/bash Mostfa
        sudo adduser Mostfa sudo
        echo 'Mostfa:root' | sudo chpasswd
        sudo usermod -aG sudo Mostfa
    
    - name: Update System
      run: |
        sudo apt update
        sudo apt upgrade -y
    
    - name: Install Desktop Environment and Dependencies
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt install -y \
          xfce4 \
          xfce4-goodies \
          xorg \
          dbus-x11 \
          x11-xserver-utils \
          firefox \
          nano \
          wget \
          curl \
          git \
          python3 \
          python3-pip \
          expect
    
    - name: Install Chrome Remote Desktop Dependencies
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt install -y \
          xserver-xorg-video-dummy \
          xbase-clients \
          python3-psutil \
          xscreensaver
    
    - name: Download and Install Chrome Remote Desktop
      run: |
        wget -q https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || true
        sudo apt install -f -y
    
    - name: Configure Chrome Remote Desktop
      run: |
        sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'
        sudo systemctl disable lightdm.service 2>/dev/null || true
        sudo adduser Mostfa chrome-remote-desktop
    
    - name: Install Additional Tools
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt install -y \
          nautilus \
          file-manager \
          gnome-terminal \
          htop \
          net-tools
    
    - name: Create Setup Script
      run: |
        cat > setup.sh << 'EOF'
        #!/bin/bash
        ${{ github.event.inputs.auth }}
        EOF
        chmod +x setup.sh
    
    - name: Initialize Chrome Remote Desktop
      run: |
        export DISPLAY=:0
        sudo -u Mostfa expect << 'EOF'
        set timeout 120
        spawn /home/Mostfa/setup.sh
        expect "Enter a PIN of at least six digits:"
        send "123456\r"
        expect "Enter the same PIN again:"
        send "123456\r"
        expect eof
        EOF
    
    - name: Start Chrome Remote Desktop Service
      run: |
        sudo -u Mostfa dbus-launch chrome-remote-desktop --start &
        sleep 10
    
    - name: Display Status
      run: |
        echo "Chrome Remote Desktop setup completed!"
        echo "User: Mostfa"
        echo "Password: root"
        echo "PIN: 123456"
        sudo -u Mostfa chrome-remote-desktop --check-service
